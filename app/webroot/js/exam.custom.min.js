var globCount = 1;
var isNav = false;
var Count = 1;
$(document).ready(function () {
$(this).bind("contextmenu", function(e) {e.preventDefault();});
    $("#exam-ddlQStatus").change(function () {
        var a = $("#exam-ddlQStatus option:selected").attr("value");
        FilterPaletteButtons(a);
    });
});

function show_modal(target) {
    waitingDialog.show();
    target = target;
    $('#targetModal').load(target, function () {
        $('#targetModal').modal('show');
        waitingDialog.hide();
    });
}
function checkAnswer(quesNo) {
    var quesType = $('#questype' + quesNo).text();
    if (quesType == "M") {
        if ($('form[name=post_req-' + quesNo + '] input[name="data[Exam][option_selected]"]').is(":checked") || $('form[name=post_req-' + quesNo + '] input[name="data[Exam][option_selected][]"]').is(":checked")) {
            return true;
        }
        else {
            return false;
        }
    }
    else if (quesType == "T") {
        if ($('form[name=post_req-' + quesNo + '] input[name="data[Exam][true_false]"]').is(":checked")) {
            return true;
        }
        else {
            return false;
        }
    }
    else if (quesType == "F") {
        if ($('form[name=post_req-' + quesNo + '] input[name="data[Exam][fill_blank]"]').val().length > 0) {
            return true;
        }
        else {
            return false;
        }
    }
    else if (quesType == "S") {
        if ($('form[name=post_req-' + quesNo + '] textarea[name="data[Exam][answer]"]').val().length > 0) {
            return true;
        }
        else {
            return false;
        }
    }
    else {
        return false;
    }
}
function resetAnswer(quesNo) {
    var quesType = $('#questype' + quesNo).text();
    if (quesType == "M") {
        $('form[name=post_req-' + quesNo + '] input[name="data[Exam][option_selected]"]').prop('checked', false);
        $('form[name=post_req-' + quesNo + '] input[name="data[Exam][option_selected][]"]').prop('checked', false);
    }
    else if (quesType == "T") {
        $('form[name=post_req-' + quesNo + '] input[name="data[Exam][true_false]"]').prop('checked', false);
    }
    else if (quesType == "F") {
        $('form[name=post_req-' + quesNo + '] input[name="data[Exam][fill_blank]"]').val('');
    }
    else if (quesType == "S") {
        $('form[name=post_req-' + quesNo + '] textarea[name="data[Exam][answer]"]').text('');
        $('form[name=post_req-' + quesNo + '] textarea[name="data[Exam][answer]"]').val('');
    }
    ChangeClassOFPaletteButton("notans", quesNo);
    getExamCounter();
    resetAnswerServer(quesNo);
}
function setPaletteColor(globCount, buttonState) {
    buttonState = buttonState || 0;
    var className = $('#navbtn' + globCount).attr('class');
    console.log(className);
    if (checkAnswer(globCount) && className == "exam-ButtonNotAnsweredMarked") {
        if(buttonState==1){
            ChangeClassOFPaletteButton("ans", globCount);
        }
        else{
            ChangeClassOFPaletteButton("ansmarked", globCount);
        }
    }
    else if (checkAnswer(globCount) && className != "exam-ButtonAnsweredMarked") {
        ChangeClassOFPaletteButton("ans", globCount);
    }
    else if (className != "exam-ButtonNotAnsweredMarked" && className != "exam-ButtonAnsweredMarked" && className != "exam-ButtonAnswered") {
        ChangeClassOFPaletteButton("notans", globCount);
    }
}
function setNavigationPaletteColor(globCount, buttonState) {
    buttonState = buttonState || 0;
    var className = $('#navbtn' + globCount).attr('class');
    if (className != "exam-ButtonNotAnsweredMarked" && className != "exam-ButtonAnsweredMarked" && className != "exam-ButtonAnswered") {
        ChangeClassOFPaletteButton("notans", globCount);
    }
}
function navigation(quesNo) {
    globCount = quesNo;
    isNav = true;
    setNavigationPaletteColor(globCount);
    showQuestionPanel(quesNo);
}

function callUserAnswerSaveNext(quesNo) {
    setPaletteColor(quesNo,1);
    if (quesNo > ($('#totalQuestion').text() - 1)) {
        $.msgBox({
            title: lang['AreYouSure'],
            content: lang['lastQuestion'],
            type: "confirm",
            buttons: [{ value: "Yes" }, { value: "No" }],
            success: function (result) {
            if (result == "Yes") {
                $('.exam-panel').hide();
                $('#quespanel1').show();
                $('.exam-SubjectButton').removeClass("exam-subjectHighlight");
                $('#btnSection1').addClass("exam-subjectHighlight");
            }
            }
        });
    }
    else {
        callNext(quesNo);
    }
    scrollExam();
    saveAnswerServer(quesNo);
}

function scrollExam() {
    if ($(window).width() < 960) {
        $('html, body').animate({scrollTop: '70px'}, 300);
    }
}
function markForReview(quesNo) {
    globCount = quesNo + 1;
    var className = $('#navbtn' + quesNo).attr('class');
    if (checkAnswer(quesNo)) {
        ChangeClassOFPaletteButton("ansmarked", quesNo);
        saveAnswerServer(quesNo);
        reviewAnswerServer(quesNo);
    }
    else {
        ChangeClassOFPaletteButton("notansmarked", quesNo);
        reviewAnswerServer(quesNo);
    }
    callNext(quesNo);

}
function callPrev(quesNo) {
    if (quesNo != 1) {
        quesNo--;
    }
    showQuestionPanel(quesNo);
}
function callNext(quesNo) {
    if ($('#totalQuestion').text() != quesNo) {
        quesNo++;
    }
    globCount=quesNo;
    //setPaletteColor(globCount);
    showQuestionPanel(quesNo);
}
function currentQuesNo() {
    currQuesNo = 1;
    $(".exam-panel").each(function () {
        if ($(this).css("display") == "block") {
            currQuesNo = $(this).attr('id').substring(9);
        }
    });
    return currQuesNo;
}
function showQuestionPanel(quesNo) {
    currQuesNo = currentQuesNo();
    $('.exam-panel').hide();
    $('#quespanel' + quesNo).show();
    var className = $('#quespanel' + quesNo).attr('class');
    var lastFive = className.substr(className.length - 5);
    var lastChar = className.substr(className.length - 1);
    $('.exam-SubjectButton').removeClass("exam-subjectHighlight");
    $('#btnSection' + lastChar).addClass("exam-subjectHighlight");
    getExamCounter();
    scrollExam();
    attemptTimeServer(quesNo, currQuesNo);
}
function getExamCounter() {
    var answered = 0;
    var notAnswered = 0;
    var notAnswerMarked = 0;
    var notVisited = 0;
    var ansMarked = 0;
    var x = $('#totalQuestion').text();
    for (var q = 1; q <= x; q++) {
        var className = $('#navbtn' + q).attr('class');
        if (className == "exam-ButtonAnswered") {
            answered++;
        }
        else if (className == "exam-ButtonNotAnswered") {
            notAnswered++;
        }
        else if (className == "exam-ButtonNotAnsweredMarked") {
            notAnswerMarked++;
        }
        else if (className == "exam-ButtonNotVisited") {
            notVisited++;
        }
        else {
            ansMarked++;
        }
    }
    $("#countAnswered").html(answered);
    $("#countNotAnswered").html(notAnswered);
    $("#countNotAnswerMarked").html(notAnswerMarked);
    $("#countNotVisited").html(notVisited);
    $("#countAnsMarked").html(ansMarked);
}
function ChangeClassOFPaletteButton(c, b) {
    var a = "navbtn" + Count.toString();
    if (typeof b != "undefined") {
        a = "navbtn" + b.toString();
    }
    var d = document.getElementById(a);
    d.attributes.removeNamedItem("class");
    if (c == "notansmarked") {
        d.className += "exam-ButtonNotAnsweredMarked";
    } else {
        if (c == "notans") {
            d.className += "exam-ButtonNotAnswered";
        } else {
            if (c == "ansmarked") {
                d.className += "exam-ButtonAnsweredMarked";
            } else {
                if (c == "ans") {
                    d.className += "exam-ButtonAnswered";
                }
            }
        }
    }
}
function FilterPaletteButtons(a) {
    $('#exam-ddlQStatus').val(a);
    if (a == "all") {
        $("#exam-divQuestionPallete button.exam-ButtonNotVisited").css("display", "block");
        $("#exam-divQuestionPallete button.exam-ButtonAnswered").css("display", "block");
        $("#exam-divQuestionPallete button.exam-ButtonAnsweredMarked").css("display", "block");
        $("#exam-divQuestionPallete button.exam-ButtonNotAnswered").css("display", "block");
        $("#exam-divQuestionPallete button.exam-ButtonNotAnsweredMarked").css("display", "block");
        return;
    }
    else {
        $("#exam-divQuestionPallete button.exam-ButtonNotVisited").css("display", "none");
        $("#exam-divQuestionPallete button.exam-ButtonAnswered").css("display", "none");
        $("#exam-divQuestionPallete button.exam-ButtonAnsweredMarked").css("display", "none");
        $("#exam-divQuestionPallete button.exam-ButtonNotAnswered").css("display", "none");
        $("#exam-divQuestionPallete button.exam-ButtonNotAnsweredMarked").css("display", "none");
    }
    if (a == "notansmarked") {
        $("#exam-divQuestionPallete button.exam-ButtonNotAnsweredMarked").css("display", "block");
    }
    else {
        if (a == "notans") {
            $("#exam-divQuestionPallete button.exam-ButtonNotAnswered").css("display", "block");
        }
        else {
            if (a == "ansmarked") {
                $("#exam-divQuestionPallete button.exam-ButtonAnsweredMarked").css("display", "block");
            }
            else {
                if (a == "ans") {
                    $("#exam-divQuestionPallete button.exam-ButtonAnswered").css("display", "block");
                }
                else {
                    if (a == "notvisit") {
                        $("#exam-divQuestionPallete button.exam-ButtonNotVisited").css("display", "block");
                    }
                }
            }
        }
    }
}
function SectionButtonClick(sectionId) {
    $('.exam-panel').hide();
    $('.subject' + sectionId).show();
    $('.exam-SubjectButton').removeClass("exam-subjectHighlight");
    $('#btnSection' + sectionId).addClass("exam-subjectHighlight");
}
function changeLang(id, langLength) {
    $('.lang-' + id).show();
    for (i = 1; i <= langLength; i++) {
        if (id != i) {
            $('.lang-' + i).hide();
        }

    }
    $('.examLang').val(id);
}
$(document).ready(function () {
    $("#btnInstructions").click(function () {
        $("#instructionBlock").addClass("exam-overlay").removeClass("hidden");
        return false;
    });

    $("#btnProfile").click(function () {
        $("#userInfo").addClass("exam-overlay").removeClass("hidden");
        return false;
    });
    $("#btnQuestionPaper").click(function () {
        $("#QuestionPaperBlock").addClass("exam-overlay").removeClass("hidden");
        return false;
    });
    $("#instructionBack").click(function () {
        $("#instructionBlock").addClass("hidden").removeClass("exam-overlay");
        return false;
    });
    $("#userinfoBack").click(function () {
        $("#userInfo").addClass("hidden").removeClass("exam-overlay");
        return false;
    });
    $("#questionPaperBack").click(function () {
        $("#QuestionPaperBlock").addClass("hidden").removeClass("exam-overlay");
        return false;
    });
    $("#instructionBlock").addClass("hidden").removeClass("exam-overlay");
    $("#userInfo").addClass("hidden").removeClass("exam-overlay");
    $("#QuestionPaperBlock").addClass("hidden").removeClass("exam-overlay");

});

function saveAnswerServer(quesNo) {
    $(document).ready(function () {
        var saveUrl = $('#saveUrl').text() + '/' + quesNo;
        $.ajax({
            method: "POST",
            data: $('#post_req-' + quesNo).serialize(),
            url: saveUrl,
        })
            .done(function (data) {

            })
            .error(function (xhr, textStatus, errorThrown) {
                retryAjax();
            });
    });
}
function resetAnswerServer(quesNo) {
    $(document).ready(function () {
        var resetUrl = $('#resetUrl').text() + '/' + quesNo;
        $.ajax({
            method: "GET",
            url: resetUrl,
        })
            .done(function (data) {

            })
            .error(function (xhr, textStatus, errorThrown) {
                retryAjax();
            });
    });
}
function reviewAnswerServer(quesNo) {
    $(document).ready(function () {
        var reviewUrl = $('#reviewAnswerUrl').text() + '/' + quesNo;
        $.ajax({
            method: "GET",
            url: reviewUrl,
        })
            .done(function (data) {

            })
            .error(function (xhr, textStatus, errorThrown) {
                retryAjax();
            });
    });
}
function attemptTimeServer(quesNo, currQuesNo) {
    $(document).ready(function () {
        var attemptTimeUrl = $('#attemptTimeUrl').text() + '/' + quesNo + '/' + currQuesNo;
        $.ajax({
            method: "GET",
            url: attemptTimeUrl,
        })
            .done(function (data) {

            })
            .error(function (xhr, textStatus, errorThrown) {
                retryAjax();
            });
    });
}
function retryAjax(xhr, textStatus, errorThrown) {
    examUrl = $('#examUrl').text();
    tryCount = 0;
    retryLimit = 3;
    if (textStatus == 'timeout') {
        tryCount++;
        if (tryCount <= retryLimit) {
            $.ajax(this);
            return;
        }
        return;
    }
    if (xhr.status == 500) {
        window.location = '+examUrl+';
    }
    else {
        window.location = '+examUrl+';
    }
}